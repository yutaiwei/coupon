define(["angular"],function(){"use strict";function e(e){return/^-?\d+\.?\d*$/.test(e.replace(/["']/g,""))}var t=angular.isDefined,o=angular.isUndefined,r=angular.isNumber,n=angular.isObject,a=angular.isArray,i=angular.extend,c=angular.toJson,s=angular.fromJson,u=angular.module("LocalStorageModule",[]);u.provider("localStorageService",function(){this.prefix="ls",this.storageType="localStorage",this.cookie={expiry:30,path:"/"},this.notify={setItem:!0,removeItem:!1},this.setPrefix=function(e){return this.prefix=e,this},this.setStorageType=function(e){return this.storageType=e,this},this.setStorageCookie=function(e,t){return this.cookie={expiry:e,path:t},this},this.setStorageCookieDomain=function(e){return this.cookie.domain=e,this},this.setNotify=function(e,t){return this.notify={setItem:e,removeItem:t},this},this.$get=["$rootScope","$window","$document","$parse",function(u,l,g,f){var d,h=this,m=h.prefix,S=h.cookie,p=h.notify,T=h.storageType;g?g[0]&&(g=g[0]):g=document,"."!==m.substr(-1)&&(m=m?m+".":"");var y=function(e){return m+e},v=function(){try{var e=T in l&&null!==l[T],t=y("__"+Math.round(1e7*Math.random()));return e&&(d=l[T],d.setItem(t,""),d.removeItem(t)),e}catch(o){return T="cookie",u.$broadcast("LocalStorageModule.notification.error",o.message),!1}}(),O=function(e,t){if(o(t)?t=null:(n(t)||a(t)||r(+t||t))&&(t=c(t)),!v||"cookie"===h.storageType)return v||u.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),p.setItem&&u.$broadcast("LocalStorageModule.notification.setitem",{key:e,newvalue:t,storageType:"cookie"}),_(e,t);try{(n(t)||a(t))&&(t=c(t)),d&&d.setItem(y(e),t),p.setItem&&u.$broadcast("LocalStorageModule.notification.setitem",{key:e,newvalue:t,storageType:h.storageType})}catch(i){return u.$broadcast("LocalStorageModule.notification.error",i.message),_(e,t)}return!0},b=function(t){if(!v||"cookie"===h.storageType)return v||u.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),A(t);var o=d?d.getItem(y(t)):null;return o&&"null"!==o?"{"===o.charAt(0)||"["===o.charAt(0)||e(o)?s(o):o:null},k=function(e){if(!v||"cookie"===h.storageType)return v||u.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),p.removeItem&&u.$broadcast("LocalStorageModule.notification.removeitem",{key:e,storageType:"cookie"}),I(e);try{d.removeItem(y(e)),p.removeItem&&u.$broadcast("LocalStorageModule.notification.removeitem",{key:e,storageType:h.storageType})}catch(t){return u.$broadcast("LocalStorageModule.notification.error",t.message),I(e)}return!0},L=function(){if(!v)return u.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),!1;var e=m.length,t=[];for(var o in d)if(o.substr(0,e)===m)try{t.push(o.substr(e))}catch(r){return u.$broadcast("LocalStorageModule.notification.error",r.Description),[]}return t},$=function(e){e=e||"";var t=m.slice(0,-1),o=new RegExp(t+"."+e);if(!v||"cookie"===h.storageType)return v||u.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),x();var r=m.length;for(var n in d)if(o.test(n))try{k(n.substr(r))}catch(a){return u.$broadcast("LocalStorageModule.notification.error",a.message),x()}return!0},M=function(){try{return l.navigator.cookieEnabled||"cookie"in g&&(g.cookie.length>0||(g.cookie="test").indexOf.call(g.cookie,"test")>-1)}catch(e){return u.$broadcast("LocalStorageModule.notification.error",e.message),!1}}(),_=function(e,t){if(o(t))return!1;if((a(t)||n(t))&&(t=c(t)),!M)return u.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var r="",i=new Date,s="";if(null===t?(i.setTime(i.getTime()+-864e5),r="; expires="+i.toGMTString(),t=""):0!==S.expiry&&(i.setTime(i.getTime()+24*S.expiry*60*60*1e3),r="; expires="+i.toGMTString()),e){var l="; path="+S.path;S.domain&&(s="; domain="+S.domain),g.cookie=y(e)+"="+encodeURIComponent(t)+r+l+s}}catch(f){return u.$broadcast("LocalStorageModule.notification.error",f.message),!1}return!0},A=function(e){if(!M)return u.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var t=g.cookie&&g.cookie.split(";")||[],o=0;o<t.length;o++){for(var r=t[o];" "===r.charAt(0);)r=r.substring(1,r.length);if(0===r.indexOf(y(e)+"=")){var n=decodeURIComponent(r.substring(m.length+e.length+1,r.length));try{var a=JSON.parse(n);return s(a)}catch(i){return n}}}return null},I=function(e){_(e,null)},x=function(){for(var e=null,t=m.length,o=g.cookie.split(";"),r=0;r<o.length;r++){for(e=o[r];" "===e.charAt(0);)e=e.substring(1,e.length);var n=e.substring(t,e.indexOf("="));I(n)}},E=function(){return T},P=function(e,o,r,a){a=a||o;var c=b(a);return null===c&&t(r)?c=r:n(c)&&n(r)&&(c=i(r,c)),f(o).assign(e,c),e.$watch(o,function(e){O(a,e)},n(e[o]))},R=function(){for(var e=0,t=l[T],o=0;o<t.length;o++)0===t.key(o).indexOf(m)&&e++;return e};return{isSupported:v,getStorageType:E,set:O,add:O,get:b,keys:L,remove:k,clearAll:$,bind:P,deriveKey:y,length:R,cookie:{isSupported:M,set:_,add:_,get:A,remove:I,clearAll:x}}}]})});